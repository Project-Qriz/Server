pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'qriz-api'
        DOCKER_TAG = "${BUILD_NUMBER}"
        AWS_REGION = 'ap-northeast-2'
        ECR_REGISTRY = '314146328505.dkr.ecr.ap-northeast-2.amazonaws.com'
        AWS_CREDENTIALS = 'aws-credentials'
        PROPERTIES_FILE = 'spring-dev-properties'
        HEALTH_CHECK_URL = 'http://dev-alb-982145495.ap-northeast-2.elb.amazonaws.com/api/health'
        // ë¡¤ë°±ì„ ìœ„í•œ ì´ë¯¸ì§€ ì •ë³´ íŒŒì¼ ê²½ë¡œ
        LAST_SUCCESSFUL_DEPLOY_FILE = '/var/jenkins_home/qriz-api-last-successful-deploy.txt'
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'dev', credentialsId: 'github-token', url: 'https://github.com/Project-Qriz/Server.git'
            }
        }

        stage('Get Last Successful Image') {
            steps {
                script {
                    // ì´ì „ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ëœ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ì½ì–´ì˜´
                    try {
                        def lastSuccessfulImage = sh(
                            script: "cat ${LAST_SUCCESSFUL_DEPLOY_FILE} || echo 'none'",
                            returnStdout: true
                        ).trim()
                        
                        echo "ì´ì „ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ëœ ì´ë¯¸ì§€: ${lastSuccessfulImage}"
                        env.LAST_SUCCESSFUL_IMAGE = lastSuccessfulImage != 'none' ? lastSuccessfulImage : null
                    } catch (Exception e) {
                        echo "ì´ì „ ë°°í¬ ì •ë³´ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${e.message}"
                        env.LAST_SUCCESSFUL_IMAGE = null
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                withCredentials([file(credentialsId: 'spring-dev-properties', variable: 'PROPERTIES_FILE')]) {
                    // íŒŒì¼ ë‚´ìš© ì½ê¸°
                    sh "cat \${PROPERTIES_FILE} > application-dev.properties"

                    sh """
                        docker build -t ${DOCKER_IMAGE}:${BUILD_NUMBER} .
                        docker tag ${DOCKER_IMAGE}:${BUILD_NUMBER} ${DOCKER_IMAGE}:latest
                    """
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    withCredentials([[
                        $class: 'AmazonWebServicesCredentialsBinding',
                        credentialsId: "${AWS_CREDENTIALS}",
                        accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                        secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                    ]]) {
                        sh """
                            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
                            docker tag ${DOCKER_IMAGE}:latest ${ECR_REGISTRY}/qriz/api:${BUILD_NUMBER}
                            docker push ${ECR_REGISTRY}/qriz/api:${BUILD_NUMBER}
                            docker tag ${DOCKER_IMAGE}:latest ${ECR_REGISTRY}/qriz/api:latest
                            docker push ${ECR_REGISTRY}/qriz/api:latest
                        """
                        
                        // ì´ë²ˆ ë°°í¬ì—ì„œ ì‚¬ìš©í•  ì´ë¯¸ì§€ë¥¼ í™˜ê²½ ë³€ìˆ˜ì— ì €ì¥
                        env.CURRENT_DEPLOY_IMAGE = "${ECR_REGISTRY}/qriz/api:${BUILD_NUMBER}"
                    }
                }
            }
        }

        stage('Deploy to Backend Server') {
            steps {
                withCredentials([
                    sshUserPrivateKey(credentialsId: 'backend-server-ssh-key', keyFileVariable: 'SSH_KEY'),
                    file(credentialsId: 'spring-dev-properties', variable: 'PROPERTIES_FILE'),
                    [
                        $class: 'AmazonWebServicesCredentialsBinding',
                        credentialsId: "${AWS_CREDENTIALS}",
                        accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                        secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                    ]
                ]) {
                    // ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ìƒì„±
                    writeFile file: 'deploy.sh', text: """#!/bin/bash
                    # 8081 í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ì»¨í…Œì´ë„ˆ ì°¾ê¸°
                    CONTAINER_ID=\$(docker ps | grep 8081 | awk '{print \$1}')
                    if [ ! -z "\$CONTAINER_ID" ]; then
                        echo "8081 í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ì»¨í…Œì´ë„ˆ \$CONTAINER_ID ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤."
                        docker stop \$CONTAINER_ID
                        docker rm \$CONTAINER_ID
                    fi

                    # ê¸°ì¡´ backend-container ì œê±°
                    docker rm -f backend-container || true

                    # ìƒˆ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ë° ì‹¤í–‰
                    docker pull ${env.CURRENT_DEPLOY_IMAGE}
                    docker run -d --name backend-container -p 8081:8081 \\
                      ${env.CURRENT_DEPLOY_IMAGE}

                    # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
                    docker ps | grep backend-container

                    # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬
                    echo "ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤."

                    # dangling ì´ë¯¸ì§€(íƒœê·¸ê°€ ì—†ëŠ” ì´ë¯¸ì§€) ì œê±°
                    docker image prune -f

                    # í˜„ì¬ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹Œ ëª¨ë“  ì»¨í…Œì´ë„ˆ ì œê±°
                    docker container prune -f

                    # ì´ì „ ë²„ì „ì˜ qriz/api ì´ë¯¸ì§€ë¥¼ ì œì™¸í•œ ëª¨ë“  ì´ë¯¸ì§€ ìœ ì§€ (ìµœì‹  5ê°œë§Œ ìœ ì§€)
                    docker images | grep "qriz/api" | grep -v "latest" | sort -r | awk 'NR>5 {print \$3}' | xargs -r docker rmi
                    """

                    // ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì„ ëŒ€ìƒ ì„œë²„ë¡œ ì „ì†¡í•˜ê³  ì‹¤í–‰
                    sh '''
                        chmod +x deploy.sh
                        scp -i ${SSH_KEY} -o StrictHostKeyChecking=no deploy.sh ec2-user@10.0.2.212:~/deploy.sh

                        ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ec2-user@10.0.2.212 "
                            # AWS ECR ë¡œê·¸ì¸
                            export AWS_ACCESS_KEY_ID='${AWS_ACCESS_KEY_ID}' &&
                            export AWS_SECRET_ACCESS_KEY='${AWS_SECRET_ACCESS_KEY}' &&
                            aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 314146328505.dkr.ecr.ap-northeast-2.amazonaws.com &&

                            # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
                            chmod +x ~/deploy.sh &&
                            ~/deploy.sh
                        "
                    '''
                }
            }
        }
        
        stage('Application Health Check') {
            steps {
                script {
                    // ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì™„ì „íˆ ì‹œì‘ë  ë•Œê¹Œì§€ 60ì´ˆ ëŒ€ê¸°
                    echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ì„ ìœ„í•´ 60ì´ˆ ëŒ€ê¸° ì¤‘..."
                    sleep(time: 60, unit: "SECONDS")
                    
                    // í—¬ìŠ¤ ì²´í¬ ì‹¤í–‰ ë° ê²°ê³¼ ì €ì¥
                    def healthCheckResponse = sh(
                        script: "curl -s ${HEALTH_CHECK_URL}",
                        returnStdout: true
                    ).trim()
                    
                    // í—¬ìŠ¤ ì²´í¬ ì‘ë‹µ ì½”ë“œ í™•ì¸ (HTTP ìƒíƒœ ì½”ë“œ)
                    def httpStatusCode = sh(
                        script: "curl -s -o /dev/null -w '%{http_code}' ${HEALTH_CHECK_URL}",
                        returnStdout: true
                    ).trim()
                    
                    // ê²°ê³¼ë¥¼ í™˜ê²½ ë³€ìˆ˜ì— ì €ì¥
                    env.HEALTH_CHECK_RESPONSE = healthCheckResponse
                    env.HTTP_STATUS_CODE = httpStatusCode
                    
                    // í—¬ìŠ¤ ì²´í¬ ê²°ê³¼ ë¶„ì„
                    if (httpStatusCode == "200") {
                        try {
                            // JSON ì‘ë‹µì—ì„œ ìƒíƒœ í™•ì¸
                            def jsonResponse = readJSON text: healthCheckResponse
                            
                            if (jsonResponse.code == 1 && jsonResponse.data.status == "UP") {
                                echo "í—¬ìŠ¤ ì²´í¬ ì„±ê³µ: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤."
                                env.HEALTH_CHECK_STATUS = "SUCCESS"
                                env.HEALTH_CHECK_MESSAGE = "ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤."
                                
                                // í˜„ì¬ ë°°í¬ ì´ë¯¸ì§€ë¥¼ ì„±ê³µí•œ ë°°í¬ë¡œ ê¸°ë¡
                                sh "echo '${env.CURRENT_DEPLOY_IMAGE}' > ${LAST_SUCCESSFUL_DEPLOY_FILE}"
                                echo "ì„±ê³µí•œ ë°°í¬ ì´ë¯¸ì§€ ê¸°ë¡: ${env.CURRENT_DEPLOY_IMAGE}"
                            } else {
                                echo "í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë¹„ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤. ìƒíƒœ: ${jsonResponse.data.status}"
                                env.HEALTH_CHECK_STATUS = "FAILURE"
                                env.HEALTH_CHECK_MESSAGE = "ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë¹„ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤. ìƒíƒœ: ${jsonResponse.data.status}"
                                error "í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë¹„ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤."
                            }
                        } catch (Exception e) {
                            echo "í—¬ìŠ¤ ì²´í¬ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ${e.message}"
                            env.HEALTH_CHECK_STATUS = "FAILURE"
                            env.HEALTH_CHECK_MESSAGE = "í—¬ìŠ¤ ì²´í¬ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ${e.message}"
                            error "í—¬ìŠ¤ ì²´í¬ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ${e.message}"
                        }
                    } else {
                        echo "í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨: HTTP ìƒíƒœ ì½”ë“œ ${httpStatusCode}"
                        env.HEALTH_CHECK_STATUS = "FAILURE"
                        env.HEALTH_CHECK_MESSAGE = "í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨: HTTP ìƒíƒœ ì½”ë“œ ${httpStatusCode}"
                        error "í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨: HTTP ìƒíƒœ ì½”ë“œ ${httpStatusCode}"
                    }
                }
            }
        }
    }

    post {
        success {
            script {
                echo 'ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ, ë°°í¬ ë° í—¬ìŠ¤ ì²´í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!'
                slackSend(
                    color: 'good',
                    message: "âœ… ë¹Œë“œ ë° ë°°í¬ ì„±ê³µ - ${env.JOB_NAME} #${env.BUILD_NUMBER}\n" +
                            "ğŸ” í—¬ìŠ¤ ì²´í¬: ì„±ê³µ\n" +
                            "ğŸ“Š ìƒíƒœ: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤.\n" +
                            "ğŸ”— ìƒì„¸ ì •ë³´: (<${env.BUILD_URL}|ë¹Œë“œ ê²°ê³¼ ë³´ê¸°>)"
                )
            }
        }
        failure {
            script {
                echo 'ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê±°ë‚˜ í—¬ìŠ¤ ì²´í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡¤ë°±ì„ ì‹œë„í•©ë‹ˆë‹¤.'
                
                // ì´ì „ ì„±ê³µí•œ ë°°í¬ ì´ë¯¸ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
                if (env.LAST_SUCCESSFUL_IMAGE) {
                    withCredentials([
                        sshUserPrivateKey(credentialsId: 'backend-server-ssh-key', keyFileVariable: 'SSH_KEY'),
                        [
                            $class: 'AmazonWebServicesCredentialsBinding',
                            credentialsId: "${AWS_CREDENTIALS}",
                            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                        ]
                    ]) {
                        // ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
                        writeFile file: 'rollback.sh', text: """#!/bin/bash
                        echo "ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
                        
                        # í˜„ì¬ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
                        docker rm -f backend-container || true
                        
                        # ì´ì „ ì„±ê³µ ì´ë¯¸ì§€ë¡œ ë¡¤ë°±
                        docker pull ${env.LAST_SUCCESSFUL_IMAGE}
                        docker run -d --name backend-container -p 8081:8081 ${env.LAST_SUCCESSFUL_IMAGE}
                        
                        echo "ë¡¤ë°± ì™„ë£Œ. ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
                        docker ps | grep backend-container
                        """
                        
                        // ë¡¤ë°± ì‹¤í–‰
                        sh '''
                            chmod +x rollback.sh
                            scp -i ${SSH_KEY} -o StrictHostKeyChecking=no rollback.sh ec2-user@10.0.2.212:~/rollback.sh
                            
                            ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ec2-user@10.0.2.212 "
                                # AWS ECR ë¡œê·¸ì¸
                                export AWS_ACCESS_KEY_ID='${AWS_ACCESS_KEY_ID}' &&
                                export AWS_SECRET_ACCESS_KEY='${AWS_SECRET_ACCESS_KEY}' &&
                                aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 314146328505.dkr.ecr.ap-northeast-2.amazonaws.com &&
                                
                                # ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
                                chmod +x ~/rollback.sh &&
                                ~/rollback.sh
                            "
                        '''
                        
                        // ë¡¤ë°± í›„ í—¬ìŠ¤ ì²´í¬
                        sleep(time: 60, unit: "SECONDS")
                        def rollbackHealthStatus = sh(
                            script: "curl -s -o /dev/null -w '%{http_code}' ${HEALTH_CHECK_URL}",
                            returnStdout: true
                        ).trim()
                        
                        if (rollbackHealthStatus == "200") {
                            env.ROLLBACK_STATUS = "SUCCESS"
                        } else {
                            env.ROLLBACK_STATUS = "FAILURE"
                        }
                        
                        // ë¡¤ë°± ê²°ê³¼ ìŠ¬ë™ ì•Œë¦¼
                        if (env.ROLLBACK_STATUS == "SUCCESS") {
                            slackSend(
                                color: 'warning',
                                message: "âš ï¸ ë°°í¬ ì‹¤íŒ¨ ë° ë¡¤ë°± ì™„ë£Œ - ${env.JOB_NAME} #${env.BUILD_NUMBER}\n" +
                                         "âŒ í˜„ì¬ ë¹Œë“œ: ì‹¤íŒ¨ (${env.HEALTH_CHECK_MESSAGE})\n" +
                                         "âœ… ë¡¤ë°±: ì„±ê³µ (ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µì›ë¨)\n" +
                                         "ğŸ”— ìƒì„¸ ì •ë³´: (<${env.BUILD_URL}|ë¹Œë“œ ê²°ê³¼ ë³´ê¸°>)"
                            )
                        } else {
                            slackSend(
                                color: 'danger',
                                message: "ğŸš¨ ë°°í¬ ì‹¤íŒ¨ ë° ë¡¤ë°± ì‹¤íŒ¨ - ${env.JOB_NAME} #${env.BUILD_NUMBER}\n" +
                                         "âŒ í˜„ì¬ ë¹Œë“œ: ì‹¤íŒ¨ (${env.HEALTH_CHECK_MESSAGE})\n" +
                                         "âŒ ë¡¤ë°±: ì‹¤íŒ¨ (ìˆ˜ë™ ê°œì… í•„ìš”)\n" +
                                         "âš ï¸ ê¸´ê¸‰: ì„œë¹„ìŠ¤ê°€ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!\n" +
                                         "ğŸ”— ìƒì„¸ ì •ë³´: (<${env.BUILD_URL}|ë¹Œë“œ ê²°ê³¼ ë³´ê¸°>)"
                            )
                        }
                    }
                } else {
                    slackSend(
                        color: 'danger',
                        message: "ğŸš¨ ë°°í¬ ì‹¤íŒ¨ - ${env.JOB_NAME} #${env.BUILD_NUMBER}\n" +
                                 "âŒ ì˜¤ë¥˜: ${env.HEALTH_CHECK_MESSAGE ?: 'ë¹Œë“œ ë˜ëŠ” ë°°í¬ ê³¼ì •ì—ì„œ ì‹¤íŒ¨ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}\n" +
                                 "âŒ ë¡¤ë°±: ë¶ˆê°€ (ì´ì „ ì„±ê³µí•œ ë°°í¬ ì •ë³´ ì—†ìŒ)\n" +
                                 "âš ï¸ ì¡°ì¹˜ í•„ìš”: ìˆ˜ë™ìœ¼ë¡œ ì´ì „ ë²„ì „ì„ ë°°í¬í•˜ê±°ë‚˜ ë¬¸ì œë¥¼ í•´ê²°í•´ì•¼ í•©ë‹ˆë‹¤.\n" +
                                 "ğŸ”— ìƒì„¸ ì •ë³´: (<${env.BUILD_URL}|ë¹Œë“œ ê²°ê³¼ ë³´ê¸°>)"
                    )
                }
            }
        }
    }
}
